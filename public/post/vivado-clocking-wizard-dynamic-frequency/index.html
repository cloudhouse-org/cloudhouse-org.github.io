<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>利用 Vivado 中的 Clocking Wizard 实现动态调整输出时钟的频率和相位以及相关应用 | CloudHouse Blog</title>
<meta name="keywords" content="FPGA 开发, Vivado, 时钟管理, AXI4Lite">
<meta name="description" content="开发背景
资源连接：Clocking Wizard v6.0 手册 pg065-clk-wiz
物理硬件平台：Xilinx Artix-7 FPGA A704
开发工具：VsCode 编译器，Vivado 综合布局，Modelsim 仿真，Verilog 开发语言
博主为了准备电赛，实现其中一个扫频的功能，便利用 Vivado 中现成的 IP 核实现动态调整锁相环输出的频率和相位。过程中发现现有的资料较少遇到不少问题，便以此写一篇文章为记录，也可以供大家参考。有问题的地方劳烦大家指出，也可以进行交流。
开发思路
由于我需要从 88MHz-108MHz，并且以 0.1MHz（100K）的频率进行扫频，再阅读手册 15-19 页其相关寄存器，发现 Clocking Wizard 其中有一个公共寄存器控制所有时钟输出频率和相位后，各自时钟还有相关寄存器自行控制。也就是说输入频率，先经过公共的整数&#43;分数倍频（如倍频 8.125），然后经过整数分频后，最后经过每个时钟各自的分频才会输出。
注意这里特别提到了倍频和分频是整数还是包含分数，分数部分只能为&quot;125&quot;的倍数，倍频只有唯一一次在公共寄存器，普通时钟自身没有倍频只有整数分频，特别的：第一个时钟有分数分频。
由于我只需要一路时钟输出，所有我选择了第一个时钟。
所有我们为了输出时钟更加的精准，我们需要计算每个频率的相关参数，但是由于硬件描述语言不便于计算相关参数，并且目标频率是有步进的（虽然是一个范围），由此我决定利用 Python 脚本生成相关参数，再作为 COE 文件导入工程，用 ROM 存放直接读取，这样子更加便捷并且时序上更简单。
最后利用 Vivado 现有的 Clocking，用 AXI4Lite 协议（握手协议）来读写其内部寄存器，从而达到改变频率和相位的效果。
（以下截出了部分的寄存器，其它寄存器描述大差不差，英语不好可以翻译一下。）

这里的 C_BASEADDR 是基准地址，是内部自己控制的，不需要我们控制，我们只需要控制 0x200 这个公共寄存器，由于相位我们单独控制就不需要控制 0x204 了，另外时钟 0 控制频率的寄存器是 0x208，往下翻发现时钟 1 是 0x214，时钟 2 是 0x220……所以我们在写代码的时候可以以时钟 0 的频率寄存器为准，地址可以是 0x208&#43;时钟号×0x00C（就是按 12 递增），同样的道理，相位寄存器也可以这样写。
写完寄存器后，要记得写重载寄存器 0x25C，Bit[0]位表示要重新加载，Bit[1]在控制重新加载默认（也就是在 Vivado 的 UI 界面配置的初始化状态），还是加载你动态写入的寄存器。加载完成后，也就是 Locked 拉高，内部会重新将 Bit[0]进行复位成 0。">
<meta name="author" content="阿呆不呆">
<link rel="canonical" href="http://localhost:1313/post/vivado-clocking-wizard-dynamic-frequency/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css" integrity="sha256-NDzEgLn/yPBMy&#43;XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/post/vivado-clocking-wizard-dynamic-frequency/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>

<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="CloudHouse Blog (Alt + H)">CloudHouse Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      利用 Vivado 中的 Clocking Wizard 实现动态调整输出时钟的频率和相位以及相关应用
    </h1>
    <div class="post-meta"><span title='2025-08-07 22:03:45 +0800 CST'>August 7, 2025</span>&nbsp;·&nbsp;<span>阿呆不呆</span>

</div>
  </header> 
  <div class="post-content"><h2 id="开发背景">开发背景<a hidden class="anchor" aria-hidden="true" href="#开发背景">#</a></h2>
<p><strong>资源连接</strong>：<a href="https://docs.xilinx.com/v/u/en-US/pg065-clk-wiz">Clocking Wizard v6.0 手册 pg065-clk-wiz</a></p>
<p><strong>物理硬件平台</strong>：Xilinx Artix-7 FPGA A704</p>
<p><strong>开发工具</strong>：VsCode 编译器，Vivado 综合布局，Modelsim 仿真，Verilog 开发语言</p>
<p>博主为了准备电赛，实现其中一个扫频的功能，便利用 Vivado 中现成的 IP 核实现动态调整锁相环输出的频率和相位。过程中发现现有的资料较少遇到不少问题，便以此写一篇文章为记录，也可以供大家参考。有问题的地方劳烦大家指出，也可以进行交流。</p>
<h2 id="开发思路">开发思路<a hidden class="anchor" aria-hidden="true" href="#开发思路">#</a></h2>
<p>由于我需要从 88MHz-108MHz，并且以 0.1MHz（100K）的频率进行扫频，再阅读手册 15-19 页其相关寄存器，发现 Clocking Wizard 其中有一个公共寄存器控制所有时钟输出频率和相位后，各自时钟还有相关寄存器自行控制。也就是说输入频率，先经过公共的整数+分数倍频（如倍频 8.125），然后经过整数分频后，最后经过每个时钟各自的分频才会输出。</p>
<p><strong>注意这里特别提到了倍频和分频是整数还是包含分数，分数部分只能为&quot;125&quot;的倍数，倍频只有唯一一次在公共寄存器，普通时钟自身没有倍频只有整数分频，特别的：第一个时钟有分数分频</strong>。</p>
<p>由于我只需要一路时钟输出，所有我选择了第一个时钟。</p>
<p>所有我们为了输出时钟更加的精准，我们需要计算每个频率的相关参数，但是由于硬件描述语言不便于计算相关参数，并且目标频率是有步进的（虽然是一个范围），由此我决定利用 Python 脚本生成相关参数，再作为 COE 文件导入工程，用 ROM 存放直接读取，这样子更加便捷并且时序上更简单。</p>
<p>最后利用 Vivado 现有的 Clocking，用 AXI4Lite 协议（握手协议）来读写其内部寄存器，从而达到改变频率和相位的效果。</p>
<p><strong>（以下截出了部分的寄存器，其它寄存器描述大差不差，英语不好可以翻译一下。）</strong></p>
<p><img loading="lazy" src="/post/vivado-clocking-wizard-dynamic-frequency/axi4-clocking-registers.png"></p>
<p>这里的 C_BASEADDR 是基准地址，是内部自己控制的，不需要我们控制，我们只需要控制 0x200 这个公共寄存器，由于相位我们单独控制就不需要控制 0x204 了，另外时钟 0 控制频率的寄存器是 0x208，往下翻发现时钟 1 是 0x214，时钟 2 是 0x220……所以我们在写代码的时候可以以时钟 0 的频率寄存器为准，地址可以是 0x208+时钟号×0x00C（就是按 12 递增），同样的道理，相位寄存器也可以这样写。</p>
<p>写完寄存器后，要记得写重载寄存器 0x25C，Bit[0]位表示要重新加载，Bit[1]在控制重新加载默认（也就是在 Vivado 的 UI 界面配置的初始化状态），还是加载你动态写入的寄存器。加载完成后，也就是 Locked 拉高，内部会重新将 Bit[0]进行复位成 0。</p>
<p><img loading="lazy" src="/post/vivado-clocking-wizard-dynamic-frequency/cbaseaddr.png"></p>
<p>这个是要用的 Clocking 的初始化界面，相信大家经常会用到。</p>
<p><img loading="lazy" src="/post/vivado-clocking-wizard-dynamic-frequency/clocking-init-interface.png"></p>
<h2 id="具体步骤">具体步骤<a hidden class="anchor" aria-hidden="true" href="#具体步骤">#</a></h2>
<h3 id="参数计算">参数计算<a hidden class="anchor" aria-hidden="true" href="#参数计算">#</a></h3>
<p>这里是使用 Python 以及输出时钟 1，我的系统输入时钟为 50MHz，所以我算的五个参数分别是：（有点个人口语描述）</p>
<ul>
<li>整数倍频（对所有时钟）</li>
<li>分数倍频（对所有时钟）</li>
<li>整数分频（对所有时钟）</li>
<li>整数分频（对第一个时钟）</li>
<li>分数分频（对第一个时钟）</li>
</ul>
<p><strong>要注意，这里凡是分数，都得是&quot;125&quot;的倍数，例如 8.125 倍频，4.250 分频。</strong></p>
<h4 id="脚本一">脚本一<a hidden class="anchor" aria-hidden="true" href="#脚本一">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> math
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_best_params</span>(target_freq, clk_in<span style="color:#f92672">=</span><span style="color:#ae81ff">50.0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    计算最接近目标频率的倍频和分频参数。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param target_freq: 目标频率 (MHz)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param clk_in: 输入时钟频率 (MHz)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :return: (整数倍频, 小数倍频, 一级整数分频, 二级整数分频, 二级小数分频)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    frac_unit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.125</span>
</span></span><span style="display:flex;"><span>    best <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    min_err <span style="color:#f92672">=</span> float(<span style="color:#e6db74">&#39;inf&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 预先生成所有可能的小数部分，避免重复计算</span>
</span></span><span style="display:flex;"><span>    frac_list <span style="color:#f92672">=</span> [round(i <span style="color:#f92672">*</span> frac_unit, <span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">8</span>)]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> mult_int <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">50</span>):  <span style="color:#75715e"># 适当减小上限，加速</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> mult_frac <span style="color:#f92672">in</span> frac_list:
</span></span><span style="display:flex;"><span>            mult <span style="color:#f92672">=</span> mult_int <span style="color:#f92672">+</span> mult_frac
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> div1 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> div2 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">15</span>):  <span style="color:#75715e"># 适当减小上限，加速</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> div_frac <span style="color:#f92672">in</span> frac_list:
</span></span><span style="display:flex;"><span>                        div <span style="color:#f92672">=</span> div2 <span style="color:#f92672">+</span> div_frac
</span></span><span style="display:flex;"><span>                        freq <span style="color:#f92672">=</span> clk_in <span style="color:#f92672">*</span> mult <span style="color:#f92672">/</span> div1 <span style="color:#f92672">/</span> div
</span></span><span style="display:flex;"><span>                        err <span style="color:#f92672">=</span> abs(freq <span style="color:#f92672">-</span> target_freq)
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> err <span style="color:#f92672">&lt;</span> min_err:
</span></span><span style="display:flex;"><span>                            min_err <span style="color:#f92672">=</span> err
</span></span><span style="display:flex;"><span>                            best <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>                                mult_int,
</span></span><span style="display:flex;"><span>                                mult_frac,
</span></span><span style="display:flex;"><span>                                div1,
</span></span><span style="display:flex;"><span>                                div2,
</span></span><span style="display:flex;"><span>                                div_frac
</span></span><span style="display:flex;"><span>                            )
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> min_err <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1e-6</span>:
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">return</span> best  <span style="color:#75715e"># 直接返回，极大加速</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> best
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">format_params</span>(freq, params):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    按指定格式输出参数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    mult_int, mult_frac, div1, div2, div_frac <span style="color:#f92672">=</span> params
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">{</span>freq<span style="color:#e6db74">}</span><span style="color:#e6db74">:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frq_mult_int = </span><span style="color:#e6db74">{</span>mult_int<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frq_mult_float = </span><span style="color:#e6db74">{</span>mult_frac<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frq_div_int_all = </span><span style="color:#e6db74">{</span>div1<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frq_div_int = </span><span style="color:#e6db74">{</span>div2<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frq_div_float = </span><span style="color:#e6db74">{</span>div_frac<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 目标频率列表，可自行修改</span>
</span></span><span style="display:flex;"><span>    target_freqs <span style="color:#f92672">=</span> [<span style="color:#ae81ff">88</span>, <span style="color:#ae81ff">88.1</span>, <span style="color:#ae81ff">88.2</span>, <span style="color:#ae81ff">88.3</span>, <span style="color:#ae81ff">88.4</span>, <span style="color:#ae81ff">88.5</span>, <span style="color:#ae81ff">88.6</span>, <span style="color:#ae81ff">88.7</span>, <span style="color:#ae81ff">88.8</span>, <span style="color:#ae81ff">88.9</span>, <span style="color:#ae81ff">89</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">89.1</span>, <span style="color:#ae81ff">89.2</span>, <span style="color:#ae81ff">89.3</span>, <span style="color:#ae81ff">89.4</span>, <span style="color:#ae81ff">89.5</span>, <span style="color:#ae81ff">89.6</span>, <span style="color:#ae81ff">89.7</span>, <span style="color:#ae81ff">89.8</span>, <span style="color:#ae81ff">89.9</span>, <span style="color:#ae81ff">90</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">90.1</span>, <span style="color:#ae81ff">90.2</span>, <span style="color:#ae81ff">90.3</span>, <span style="color:#ae81ff">90.4</span>, <span style="color:#ae81ff">90.5</span>, <span style="color:#ae81ff">90.6</span>, <span style="color:#ae81ff">90.7</span>, <span style="color:#ae81ff">90.8</span>, <span style="color:#ae81ff">90.9</span>, <span style="color:#ae81ff">91</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">91.1</span>, <span style="color:#ae81ff">91.2</span>, <span style="color:#ae81ff">91.3</span>, <span style="color:#ae81ff">91.4</span>, <span style="color:#ae81ff">91.5</span>, <span style="color:#ae81ff">91.6</span>, <span style="color:#ae81ff">91.7</span>, <span style="color:#ae81ff">91.8</span>, <span style="color:#ae81ff">91.9</span>, <span style="color:#ae81ff">92</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">92.1</span>, <span style="color:#ae81ff">92.2</span>, <span style="color:#ae81ff">92.3</span>, <span style="color:#ae81ff">92.4</span>, <span style="color:#ae81ff">92.5</span>, <span style="color:#ae81ff">92.6</span>, <span style="color:#ae81ff">92.7</span>, <span style="color:#ae81ff">92.8</span>, <span style="color:#ae81ff">92.9</span>, <span style="color:#ae81ff">93</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">93.1</span>, <span style="color:#ae81ff">93.2</span>, <span style="color:#ae81ff">93.3</span>, <span style="color:#ae81ff">93.4</span>, <span style="color:#ae81ff">93.5</span>, <span style="color:#ae81ff">93.6</span>, <span style="color:#ae81ff">93.7</span>, <span style="color:#ae81ff">93.8</span>, <span style="color:#ae81ff">93.9</span>, <span style="color:#ae81ff">94</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">94.1</span>, <span style="color:#ae81ff">94.2</span>, <span style="color:#ae81ff">94.3</span>, <span style="color:#ae81ff">94.4</span>, <span style="color:#ae81ff">94.5</span>, <span style="color:#ae81ff">94.6</span>, <span style="color:#ae81ff">94.7</span>, <span style="color:#ae81ff">94.8</span>, <span style="color:#ae81ff">94.9</span>, <span style="color:#ae81ff">95</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">95.1</span>, <span style="color:#ae81ff">95.2</span>, <span style="color:#ae81ff">95.3</span>, <span style="color:#ae81ff">95.4</span>, <span style="color:#ae81ff">95.5</span>, <span style="color:#ae81ff">95.6</span>, <span style="color:#ae81ff">95.7</span>, <span style="color:#ae81ff">95.8</span>, <span style="color:#ae81ff">95.9</span>, <span style="color:#ae81ff">96</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">96.1</span>, <span style="color:#ae81ff">96.2</span>, <span style="color:#ae81ff">96.3</span>, <span style="color:#ae81ff">96.4</span>, <span style="color:#ae81ff">96.5</span>, <span style="color:#ae81ff">96.6</span>, <span style="color:#ae81ff">96.7</span>, <span style="color:#ae81ff">96.8</span>, <span style="color:#ae81ff">96.9</span>, <span style="color:#ae81ff">97</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">97.1</span>, <span style="color:#ae81ff">97.2</span>, <span style="color:#ae81ff">97.3</span>, <span style="color:#ae81ff">97.4</span>, <span style="color:#ae81ff">97.5</span>, <span style="color:#ae81ff">97.6</span>, <span style="color:#ae81ff">97.7</span>, <span style="color:#ae81ff">97.8</span>, <span style="color:#ae81ff">97.9</span>, <span style="color:#ae81ff">98</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">98.1</span>, <span style="color:#ae81ff">98.2</span>, <span style="color:#ae81ff">98.3</span>, <span style="color:#ae81ff">98.4</span>, <span style="color:#ae81ff">98.5</span>, <span style="color:#ae81ff">98.6</span>, <span style="color:#ae81ff">98.7</span>, <span style="color:#ae81ff">98.8</span>, <span style="color:#ae81ff">98.9</span>, <span style="color:#ae81ff">99</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">99.1</span>, <span style="color:#ae81ff">99.2</span>, <span style="color:#ae81ff">99.3</span>, <span style="color:#ae81ff">99.4</span>, <span style="color:#ae81ff">99.5</span>, <span style="color:#ae81ff">99.6</span>, <span style="color:#ae81ff">99.7</span>, <span style="color:#ae81ff">99.8</span>, <span style="color:#ae81ff">99.9</span>, <span style="color:#ae81ff">100</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">100.1</span>, <span style="color:#ae81ff">100.2</span>, <span style="color:#ae81ff">100.3</span>, <span style="color:#ae81ff">100.4</span>, <span style="color:#ae81ff">100.5</span>, <span style="color:#ae81ff">100.6</span>, <span style="color:#ae81ff">100.7</span>, <span style="color:#ae81ff">100.8</span>, <span style="color:#ae81ff">100.9</span>, <span style="color:#ae81ff">101</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">101.1</span>, <span style="color:#ae81ff">101.2</span>, <span style="color:#ae81ff">101.3</span>, <span style="color:#ae81ff">101.4</span>, <span style="color:#ae81ff">101.5</span>, <span style="color:#ae81ff">101.6</span>, <span style="color:#ae81ff">101.7</span>, <span style="color:#ae81ff">101.8</span>, <span style="color:#ae81ff">101.9</span>, <span style="color:#ae81ff">102</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">102.1</span>, <span style="color:#ae81ff">102.2</span>, <span style="color:#ae81ff">102.3</span>, <span style="color:#ae81ff">102.4</span>, <span style="color:#ae81ff">102.5</span>, <span style="color:#ae81ff">102.6</span>, <span style="color:#ae81ff">102.7</span>, <span style="color:#ae81ff">102.8</span>, <span style="color:#ae81ff">102.9</span>, <span style="color:#ae81ff">103</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">103.1</span>, <span style="color:#ae81ff">103.2</span>, <span style="color:#ae81ff">103.3</span>, <span style="color:#ae81ff">103.4</span>, <span style="color:#ae81ff">103.5</span>, <span style="color:#ae81ff">103.6</span>, <span style="color:#ae81ff">103.7</span>, <span style="color:#ae81ff">103.8</span>, <span style="color:#ae81ff">103.9</span>, <span style="color:#ae81ff">104</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">104.1</span>, <span style="color:#ae81ff">104.2</span>, <span style="color:#ae81ff">104.3</span>, <span style="color:#ae81ff">104.4</span>, <span style="color:#ae81ff">104.5</span>, <span style="color:#ae81ff">104.6</span>, <span style="color:#ae81ff">104.7</span>, <span style="color:#ae81ff">104.8</span>, <span style="color:#ae81ff">104.9</span>, <span style="color:#ae81ff">105</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">105.1</span>, <span style="color:#ae81ff">105.2</span>, <span style="color:#ae81ff">105.3</span>, <span style="color:#ae81ff">105.4</span>, <span style="color:#ae81ff">105.5</span>, <span style="color:#ae81ff">105.6</span>, <span style="color:#ae81ff">105.7</span>, <span style="color:#ae81ff">105.8</span>, <span style="color:#ae81ff">105.9</span>, <span style="color:#ae81ff">106</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">106.1</span>, <span style="color:#ae81ff">106.2</span>, <span style="color:#ae81ff">106.3</span>, <span style="color:#ae81ff">106.4</span>, <span style="color:#ae81ff">106.5</span>, <span style="color:#ae81ff">106.6</span>, <span style="color:#ae81ff">106.7</span>, <span style="color:#ae81ff">106.8</span>, <span style="color:#ae81ff">106.9</span>, <span style="color:#ae81ff">107</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">107.1</span>, <span style="color:#ae81ff">107.2</span>, <span style="color:#ae81ff">107.3</span>, <span style="color:#ae81ff">107.4</span>, <span style="color:#ae81ff">107.5</span>, <span style="color:#ae81ff">107.6</span>, <span style="color:#ae81ff">107.7</span>, <span style="color:#ae81ff">107.8</span>, <span style="color:#ae81ff">107.9</span>, <span style="color:#ae81ff">108</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;freq_params.txt&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> freq <span style="color:#f92672">in</span> target_freqs:
</span></span><span style="display:flex;"><span>            params <span style="color:#f92672">=</span> find_best_params(freq)
</span></span><span style="display:flex;"><span>            f<span style="color:#f92672">.</span>write(format_params(freq, params))
</span></span></code></pre></div><p>这个脚本就是生成相关参数，并且将其以如下格式输出到 freq_params.txt 文件里面，经过验证它的精度可以去到小数点后三位，所以已经满足了我比赛的要求，看官也可以自己计算一下（50MHz 作为输入）。接下来，要将他们按照不同参数分到不同的 ROM 里面，就需要就行归类。并且在开头加上 COE 文件的两行，这就要利用脚本二了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>MEMORY_INITIALIZATION_RADIX=10;
</span></span><span style="display:flex;"><span>MEMORY_INITIALIZATION_VECTOR=
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>88.1:
</span></span><span style="display:flex;"><span>frq_mult_int = 4
</span></span><span style="display:flex;"><span>frq_mult_float = 0.625
</span></span><span style="display:flex;"><span>frq_div_int_all = 1
</span></span><span style="display:flex;"><span>frq_div_int = 2
</span></span><span style="display:flex;"><span>frq_div_float = 0.625
</span></span></code></pre></div><h3 id="ip-核配置">IP 核配置<a hidden class="anchor" aria-hidden="true" href="#ip-核配置">#</a></h3>
<p><img loading="lazy" src="/post/vivado-clocking-wizard-dynamic-frequency/ip-config-1.png">
<img loading="lazy" src="/post/vivado-clocking-wizard-dynamic-frequency/ip-config-2.png"></p>
<p>这里使用的实现方式是 MMCM，可以说 MMCM 是增强版的 PLL，其对输出时钟的控制灵活性和精度更大。我的输入时钟是单端的 50MHz 系统时钟，输出选择了时钟 1，初始化 88MHz。</p>
<ul>
<li><strong>Frequency Synthesis</strong>：表示可以生成不同频率的时钟</li>
<li><strong>Phase Alignment</strong>：已知输入时钟的频率和相位</li>
<li><strong>Dynamic Reconfig</strong>：表示可以创新改写寄存器</li>
<li><strong>AXI4Lite</strong>：是一种接口协议，其实就是握手信号，也可以选择 DRP 不过相关的寄存器地址就会发生改变，并且文档还是另一个，当时最开始是使用这个协议，一直没效果便改成了 AXI4Lite，其实这个是对 DRP 的再一次封装</li>
<li><strong>Phase Duty Cycle Config</strong>：如果要修改相位，得勾上这个</li>
</ul>
<p><img loading="lazy" src="/post/vivado-clocking-wizard-dynamic-frequency/axi-ports.png"></p>
<p>可以看到，配置完后，左边 IP Symbol 界面展示了现有的端口，其中展开可以看到 AXI4Lite 协议的相关端口。其中各个端口的含义可以查看一下手册里面的说明，简单来说其实就是写地址+写数据+写有效位标识以及他们各自的握手信号，写完一次后，还有应答信号以及应答信号的握手信号。</p>
<p><strong>（特别的读写是分开的）</strong></p>
<p><img loading="lazy" src="/post/vivado-clocking-wizard-dynamic-frequency/axi-port-interface-1.png">
<img loading="lazy" src="/post/vivado-clocking-wizard-dynamic-frequency/axi-port-interface-2.png"></p>
<h3 id="驱动-clocking-wizard-模块">驱动 Clocking Wizard 模块<a hidden class="anchor" aria-hidden="true" href="#驱动-clocking-wizard-模块">#</a></h3>
<p>可以发现，我们可以将修改寄存器作为一个 module 模块，然后用一个上级模块控制写入的参数和顺序。</p>
<h4 id="time_tree_dyv">time_tree_dy.v<a hidden class="anchor" aria-hidden="true" href="#time_tree_dyv">#</a></h4>
<p>这个模块是用来控制读写的，大致的思路是使用二段式的状态机，会先计算总共要写入的次数，然后先写公共寄存器，然后依次写各自时钟的频率寄存器，在依次写各自时钟的相位寄存器，最后写重加载寄存器。</p>
<p><strong>（我这里预留了俩路信号，是到处验证的时候为了做对比，可以通过端口定义的 clk_control_num 配合 Vivado 的 UI 界面勾选时钟的数量，保证整个代码的通用性）</strong></p>
<p>不过，为了代码写的方便，所以这里我的端口有点多，显得有点唐，不过在上级控制模块会有 5 个 ROM 读取上述的五个参数，可以直接传递给对应端口，所以怎么方便怎么来吧。</p>
<p>另外一些特别的地方我都有注释。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#75715e">/*==============================================
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* Function Name  : time_tree_dy.v
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* Description    : 该模块是为了动态设计时钟树，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*                  主要听从于STM32F4的需求，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*                  通过动态配置实现不同频率的时钟输出
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* input port     : 详细接口见下方注释
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* output port    : 详细接口见下方注释
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* Author         : ADBD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*==============================================*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> time_tree_dy(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span>         sys_clk,        <span style="color:#75715e">// 系统时钟
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span>         rst_n,          <span style="color:#75715e">// 低电平复位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span>         enable,         <span style="color:#75715e">// 模块启动信号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span>         valid,          <span style="color:#75715e">// 输入有效信号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">reg</span>          ready,          <span style="color:#75715e">// 输出就绪信号，表示模块已准备好接收数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]    clk_control_num,<span style="color:#75715e">// 需要控制的时钟总数量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]    clk_choise,     <span style="color:#75715e">// 时钟选择信号，0表示全部时钟，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                          <span style="color:#75715e">// 1表示时钟1，2表示时钟2，3表示时钟3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span>          phase_enable,   <span style="color:#75715e">// 相位使能信号，1-使能相位配置，0-不使能相位配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]    frq_mult_int,   <span style="color:#75715e">// 频率倍频系数，正数部分，对于全部时钟
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> [<span style="color:#ae81ff">9</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]    frq_mult_float, <span style="color:#75715e">// 频率倍频系数，小数部分，对于全部时钟
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]    frq_div_int,    <span style="color:#75715e">// 频率分频系数,整数部分，复用，可对所有时钟，也可以对某个时钟
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> [<span style="color:#ae81ff">9</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]    frq_div_float,  <span style="color:#75715e">// 频率分频系数,小数部分，对于时钟1才有小数分频
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> [<span style="color:#ae81ff">31</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]   frq_phase_value,<span style="color:#75715e">// 频率相位值，对各自的时钟进行设置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">wire</span>          accomplish,     <span style="color:#75715e">// 表示写寄存器全部完成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">wire</span>          error_sign,     <span style="color:#75715e">// 错误信号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">wire</span>          clk_out1,       <span style="color:#75715e">// 输出时钟1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">wire</span>          locked          <span style="color:#75715e">// 锁定信号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 状态机定义和逻辑实现...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 详细代码实现见原文
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    clk_module clk_module_inst (
</span></span><span style="display:flex;"><span>        .s_axi_aclk(sys_clk),
</span></span><span style="display:flex;"><span>        .s_axi_aresetn(rst_n),
</span></span><span style="display:flex;"><span>        .s_axi_awaddr(s_axi_awaddr),
</span></span><span style="display:flex;"><span>        .s_axi_awvalid(s_axi_awvalid),
</span></span><span style="display:flex;"><span>        .s_axi_awready(s_axi_awready),
</span></span><span style="display:flex;"><span>        .s_axi_wdata(s_axi_wdata),
</span></span><span style="display:flex;"><span>        .s_axi_wstrb(s_axi_wstrb),
</span></span><span style="display:flex;"><span>        .s_axi_wvalid(s_axi_wvalid),
</span></span><span style="display:flex;"><span>        .s_axi_wready(s_axi_wready),
</span></span><span style="display:flex;"><span>        .s_axi_bresp(s_axi_bresp),
</span></span><span style="display:flex;"><span>        .s_axi_bvalid(s_axi_bvalid),
</span></span><span style="display:flex;"><span>        .s_axi_bready(s_axi_bready),
</span></span><span style="display:flex;"><span>        .clk_out1(clk_out1),
</span></span><span style="display:flex;"><span>        .locked(locked),
</span></span><span style="display:flex;"><span>        .clk_in1(sys_clk)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><h4 id="mmcm_controlv">MMCM_Control.v<a hidden class="anchor" aria-hidden="true" href="#mmcm_controlv">#</a></h4>
<p>这个模块控制通过握手信号进行参数的传输，和 ROM 的按顺序读取。也是用状态机写的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> MMCM_Control(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span>      sys_clk,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span>      rst_n,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">wire</span>     clk_out1,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">reg</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] frq,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span>      frq_search_over,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span>      clc_accompish,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">wire</span>      locked
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span>  IDLE        <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                START       <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                WRITE       <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>                WAIT        <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>                Once_OVER   <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>,
</span></span><span style="display:flex;"><span>                OVER        <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">wire</span> ready;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">wire</span> accomplish;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ROM 实例化和控制逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    frq_mult_int_rom frq_mult_int_rom_inst(
</span></span><span style="display:flex;"><span>        .addra(addra),
</span></span><span style="display:flex;"><span>        .clka(sys_clk),
</span></span><span style="display:flex;"><span>        .douta(frq_mult_int_all)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 其他 ROM 实例化...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    time_tree_dy time_tree_dy_inst (
</span></span><span style="display:flex;"><span>        .sys_clk(sys_clk),
</span></span><span style="display:flex;"><span>        .rst_n(rst_n),
</span></span><span style="display:flex;"><span>        .enable(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>),
</span></span><span style="display:flex;"><span>        .valid(valid),
</span></span><span style="display:flex;"><span>        .ready(ready),
</span></span><span style="display:flex;"><span>        .clk_control_num(<span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;b1</span>),
</span></span><span style="display:flex;"><span>        .clk_choise(clk_choise),
</span></span><span style="display:flex;"><span>        .phase_enable(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>),
</span></span><span style="display:flex;"><span>        .frq_mult_int(frq_mult_int_all),
</span></span><span style="display:flex;"><span>        .frq_mult_float(frq_mult_float_all),
</span></span><span style="display:flex;"><span>        .frq_div_int(frq_div_int_w),
</span></span><span style="display:flex;"><span>        .frq_div_float(frq_div_float),
</span></span><span style="display:flex;"><span>        .frq_phase_value(<span style="color:#ae81ff">32</span><span style="color:#ae81ff">&#39;d0</span>),
</span></span><span style="display:flex;"><span>        .accomplish(accomplish),
</span></span><span style="display:flex;"><span>        .error_sign(error_sign),
</span></span><span style="display:flex;"><span>        .clk_out1(clk_out1),
</span></span><span style="display:flex;"><span>        .locked(locked)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><h3 id="验证">验证<a hidden class="anchor" aria-hidden="true" href="#验证">#</a></h3>
<p>用 Vivado+Modelsim 联合仿真。</p>
<p><strong>这里要注意，要等待 IP 核的 locked 信号拉高后，也就是信号稳定后，才能进行后续。</strong></p>
<p><img loading="lazy" src="/post/vivado-clocking-wizard-dynamic-frequency/modelsim-1.png"></p>
<p>这个是写入 IP 核的端口时序。</p>
<p><img loading="lazy" src="/post/vivado-clocking-wizard-dynamic-frequency/modelsim-2.png"></p>
<p>这个是写一次后，locked 信号拉高后，输出信号周期为 11351ps，计算得为 88.097MHz 接近 88.1MHz。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/fpga-%E5%BC%80%E5%8F%91/">FPGA 开发</a></li>
      <li><a href="http://localhost:1313/tags/vivado/">Vivado</a></li>
      <li><a href="http://localhost:1313/tags/%E6%97%B6%E9%92%9F%E7%AE%A1%E7%90%86/">时钟管理</a></li>
      <li><a href="http://localhost:1313/tags/axi4lite/">AXI4Lite</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">CloudHouse Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
